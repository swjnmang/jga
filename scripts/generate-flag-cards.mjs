#!/usr/bin/env node
import fs from 'node:fs';
import path from 'node:path';

const root = process.cwd();
const flagsDir = path.join(root, 'public', 'assets', 'flags');
const outFile = path.join(root, 'lib', 'flagCards.ts');
const csvFile = path.join(root, 'public', 'assets', 'liste laender.csv');

// Load country years from CSV
const countryYears = {};
const countryMapping = {
  'Vereinigte Arabische Emirate': 'Ver. Arab. Emirate',
  'Vereinigte Staaten': 'USA',
  'Südkorea': 'Südkorea',
  'Nordkorea': 'Nordkorea',
  'Republik Kongo': 'Kongo (Rep.)',
  'Demokratische Republik Kongo': 'Kongo (Dem. Rep.)',
  'Côte d\'Ivoire': 'Elfenbeinküste',
  'Timor-Leste': 'Osttimor',
  'Vereinigtes Königreich': 'UK', // fallback
  'Britische Jungferninseln': 'UK',
  'Kaimaninseln': 'UK',
  'Falklandinseln': 'UK',
  'Gibraltar': 'UK',
  'Britische Abhängigkeiten': 'UK',
};

if (fs.existsSync(csvFile)) {
  const csvContent = fs.readFileSync(csvFile, 'utf-8');
  const lines = csvContent.split('\n').slice(1); // Skip header
  for (const line of lines) {
    if (!line.trim()) continue;
    const [year, land] = line.split(',').map(s => s.trim());
    if (year && land) {
      countryYears[land] = parseInt(year, 10);
    }
  }
}

function toDisplayName(code) {
  try {
    const dn = new Intl.DisplayNames(['de'], { type: 'region' });
    const name = dn.of(code.toUpperCase());
    if (name && name !== code.toUpperCase()) return name;
  } catch (_) {
    // ignore
  }
  return code.toUpperCase();
}

function getYear(name) {
  // Direct match
  if (countryYears[name]) return countryYears[name];
  
  // Try mapping
  const mapped = countryMapping[name];
  if (mapped && countryYears[mapped]) return countryYears[mapped];
  
  // Fallback
  return 1900;
}

// European country codes (ISO 3166-1 alpha-2)
const europeanCountries = new Set([
  'ad', 'al', 'at', 'ax', 'ba', 'be', 'bg', 'by', 'ch', 'cy', 'cz', 'de', 'dk', 'ee', 'es', 'fi', 'fo', 'fr', 'gb', 'ge', 'gg', 'gi', 'gr', 'hr', 'hu', 'ie', 'im', 'is', 'it', 'je', 'li', 'lt', 'lu', 'lv', 'mc', 'md', 'me', 'mk', 'mt', 'nl', 'no', 'pl', 'pt', 'ro', 'rs', 'ru', 'se', 'si', 'sj', 'sk', 'sm', 'ua', 'va', 'xk'
]);

function getDifficulty(code) {
  return europeanCountries.has(code.toLowerCase()) ? 'einfach' : 'mittel';
}

const files = fs.readdirSync(flagsDir).filter((f) => f.toLowerCase().endsWith('.png')).sort();
const seen = new Set();
const cards = [];
for (const file of files) {
  const code = file.replace(/\.png$/i, '');
  if (seen.has(code)) continue;
  seen.add(code);
  const name = toDisplayName(code);
  const year = getYear(name);
  const difficulty = getDifficulty(code);
  
  cards.push({
    id: `flag-${code.toLowerCase()}`,
    title: `Flagge ${name}`,
    category: 'country',
    year: year,
    cue: 'Zu welchem Land gehört diese Flagge und wann wurde es gegründet?',
    answer: `${name} – Staatsflagge (Jahr variabel).`,
    hint: name,
    difficulty: difficulty,
    sources: {
      image: `/assets/flags/${file}`
    }
  });
}

const content = `// AUTO-GENERATED by scripts/generate-flag-cards.mjs\n// Do not edit manually.\nimport { Card } from './types';\n\nexport const flagCards: Card[] = ${JSON.stringify(cards, null, 2)};\n`;
fs.writeFileSync(outFile, content);
console.log(`Wrote ${cards.length} flag cards to ${path.relative(root, outFile)}`);
