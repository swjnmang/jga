#!/usr/bin/env node
import fs from 'node:fs';
import path from 'node:path';

const root = process.cwd();
const sourceRoot = path.join(root, 'mapsicon', 'all');
const destDir = path.join(root, 'public', 'assets', 'country-outlines');
const outFile = path.join(root, 'lib', 'outlineCards.ts');

if (!fs.existsSync(sourceRoot)) {
  console.error('Source folder not found:', sourceRoot);
  process.exit(1);
}
if (!fs.existsSync(destDir)) fs.mkdirSync(destDir, { recursive: true });

const regionNames = new Intl.DisplayNames(['de'], { type: 'region' });

function toName(code) {
  try {
    const maybe = regionNames.of(code.toUpperCase());
    if (maybe && maybe !== code.toUpperCase()) return maybe;
  } catch (_) {
    // ignore
  }
  return code.toUpperCase();
}

// European country codes (ISO 3166-1 alpha-2)
const europeanCountries = new Set([
  'ad', 'al', 'at', 'ax', 'ba', 'be', 'bg', 'by', 'ch', 'cy', 'cz', 'de', 'dk', 'ee', 'es', 'fi', 'fo', 'fr', 'gb', 'ge', 'gg', 'gi', 'gr', 'hr', 'hu', 'ie', 'im', 'is', 'it', 'je', 'li', 'lt', 'lu', 'lv', 'mc', 'md', 'me', 'mk', 'mt', 'nl', 'no', 'pl', 'pt', 'ro', 'rs', 'ru', 'se', 'si', 'sj', 'sk', 'sm', 'ua', 'va', 'xk'
]);

// Population-based difficulty (approximate population in millions)
// einfach: >80M, mittel: 15-80M, schwer: <15M
const largePopulation = new Set([
  'cn', 'in', 'us', 'id', 'pk', 'br', 'ng', 'bd', 'mx', 'jp', 'et', 'ph', 'eg', 'vn', 'cd', 'tr', 'ir', 'th'
]);
const mediumPopulation = new Set([
  'za', 'tz', 'ke', 'kr', 'co', 'ar', 'dz', 'sd', 'ug', 'ua', 'ca', 'ma', 'sa', 'uz', 'pe', 've', 'af', 'my', 'ao', 'gh', 'np', 'ye', 'mg', 'kp', 'cm', 'ci', 'au', 'ne', 'lk', 'bf', 'ml', 'mw', 'cl', 'zm', 'ro', 'kz', 'sy', 'ec', 'gt', 'sn', 'td', 'so', 'zw', 'gn', 'rw', 'bj', 'tn', 'bi', 'bo', 'ht', 'do', 'cz', 'be', 'cu', 'tn', 'jo', 'az', 'tj', 'hn', 'il', 'pg', 'ch', 'tg', 'hk', 'at', 'rs', 'hu', 'by'
]);

function getDifficulty(code) {
  const lower = code.toLowerCase();
  // European countries are always easy
  if (europeanCountries.has(lower)) return 'einfach';
  // Non-European: population-based
  if (largePopulation.has(lower)) return 'einfach';
  if (mediumPopulation.has(lower)) return 'mittel';
  return 'schwer';
}

const cards = [];
const entries = fs.readdirSync(sourceRoot, { withFileTypes: true });
for (const entry of entries) {
  if (!entry.isDirectory()) continue;
  if (entry.name === 'States of the United States') continue; // skip sub-national set
  const code = entry.name.toLowerCase();
  const srcPng = path.join(sourceRoot, entry.name, '1024.png');
  if (!fs.existsSync(srcPng)) continue;
  const destPng = path.join(destDir, `${code}.png`);
  fs.copyFileSync(srcPng, destPng);

  const displayName = toName(code);
  const difficulty = getDifficulty(code);
  cards.push({
    id: `outline-${code}`,
    title: `Umriss ${displayName}`,
    category: 'country',
    year: 1900,
    cue: 'Zu welchem Land gehört dieser Umriss und wann wurde es gegründet?',
    answer: `${displayName} – Staatsumriss. Quelle: mapsicon (CC BY 4.0).`,
    hint: displayName,
    difficulty: difficulty,
    sources: {
      image: `/assets/country-outlines/${code}.png`,
      text: 'mapsicon by djaiss (CC BY 4.0)'
    }
  });
}

const content = `// AUTO-GENERATED by scripts/generate-outline-cards.mjs\n// Do not edit manually.\nimport { Card } from './types';\n\nexport const outlineCards: Card[] = ${JSON.stringify(cards, null, 2)};\n`;
fs.writeFileSync(outFile, content);
console.log(`Wrote ${cards.length} outline cards to ${path.relative(root, outFile)}`);
