#!/usr/bin/env node
import fs from 'node:fs';
import path from 'node:path';

const root = process.cwd();
const sourceRoot = path.join(root, 'mapsicon', 'all');
const destDir = path.join(root, 'public', 'assets', 'country-outlines');
const outFile = path.join(root, 'lib', 'outlineCards.ts');

if (!fs.existsSync(sourceRoot)) {
  console.error('Source folder not found:', sourceRoot);
  process.exit(1);
}
if (!fs.existsSync(destDir)) fs.mkdirSync(destDir, { recursive: true });

const regionNames = new Intl.DisplayNames(['de'], { type: 'region' });

function toName(code) {
  try {
    const maybe = regionNames.of(code.toUpperCase());
    if (maybe && maybe !== code.toUpperCase()) return maybe;
  } catch (_) {
    // ignore
  }
  return code.toUpperCase();
}

// European country codes (ISO 3166-1 alpha-2)
const europeanCountries = new Set([
  'ad', 'al', 'at', 'ax', 'ba', 'be', 'bg', 'by', 'ch', 'cy', 'cz', 'de', 'dk', 'ee', 'es', 'fi', 'fo', 'fr', 'gb', 'ge', 'gg', 'gi', 'gr', 'hr', 'hu', 'ie', 'im', 'is', 'it', 'je', 'li', 'lt', 'lu', 'lv', 'mc', 'md', 'me', 'mk', 'mt', 'nl', 'no', 'pl', 'pt', 'ro', 'rs', 'ru', 'se', 'si', 'sj', 'sk', 'sm', 'ua', 'va', 'xk'
]);

function getDifficulty(code) {
  return europeanCountries.has(code.toLowerCase()) ? 'einfach' : 'mittel';
}

const cards = [];
const entries = fs.readdirSync(sourceRoot, { withFileTypes: true });
for (const entry of entries) {
  if (!entry.isDirectory()) continue;
  if (entry.name === 'States of the United States') continue; // skip sub-national set
  const code = entry.name.toLowerCase();
  const srcPng = path.join(sourceRoot, entry.name, '1024.png');
  if (!fs.existsSync(srcPng)) continue;
  const destPng = path.join(destDir, `${code}.png`);
  fs.copyFileSync(srcPng, destPng);

  const displayName = toName(code);
  const difficulty = getDifficulty(code);
  cards.push({
    id: `outline-${code}`,
    title: `Umriss ${displayName}`,
    category: 'country',
    year: 1900,
    cue: 'Zu welchem Land gehört dieser Umriss und wann wurde es gegründet?',
    answer: `${displayName} – Staatsumriss. Quelle: mapsicon (CC BY 4.0).`,
    hint: displayName,
    difficulty: difficulty,
    sources: {
      image: `/assets/country-outlines/${code}.png`,
      text: 'mapsicon by djaiss (CC BY 4.0)'
    }
  });
}

const content = `// AUTO-GENERATED by scripts/generate-outline-cards.mjs\n// Do not edit manually.\nimport { Card } from './types';\n\nexport const outlineCards: Card[] = ${JSON.stringify(cards, null, 2)};\n`;
fs.writeFileSync(outFile, content);
console.log(`Wrote ${cards.length} outline cards to ${path.relative(root, outFile)}`);
