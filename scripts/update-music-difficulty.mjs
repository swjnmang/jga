#!/usr/bin/env node
import fs from 'node:fs';
import path from 'node:path';

const root = process.cwd();
const inFile = path.join(root, 'lib', 'playlistCards.ts');

// Read the file
const content = fs.readFileSync(inFile, 'utf-8');

// Extract the array content
const match = content.match(/export const playlistCards: Card\[\] = (\[[\s\S]*\]);/);
if (!match) {
  console.error('Could not parse playlistCards array');
  process.exit(1);
}

const cards = JSON.parse(match[1]);

// Mainstream genres (easier to recognize)
const mainstreamGenres = new Set([
  'pop', 'rock', 'hiphop', 'rap', 'dance', 'edm', 'house', 'electro',
  'rnb', 'soul', 'funk', 'disco', 'reggae', 'indie', 'alternative',
  'punk', 'metal', 'schlager', 'schlagerparty', 'party', 'charts',
  'top40', 'mainstream', 'poprock', 'danceelectronic', 'urbancontemporary'
]);

function calculateDifficulty(card) {
  const year = card.year;
  const genres = card.genres || [];
  
  // Year-based score (0-10)
  // Recent songs (2010+) = 0-3 points
  // 2000s = 3-5 points
  // 1990s = 5-7 points
  // 1980s = 7-9 points
  // Pre-1980 = 9-10 points
  let yearScore = 0;
  if (year >= 2015) yearScore = 0;
  else if (year >= 2010) yearScore = 2;
  else if (year >= 2000) yearScore = 4;
  else if (year >= 1990) yearScore = 6;
  else if (year >= 1980) yearScore = 8;
  else yearScore = 10;
  
  // Genre-based score (0-10)
  // All mainstream = 0 points
  // Mixed = 5 points
  // All niche = 10 points
  let genreScore = 10;
  if (genres.length > 0) {
    const mainstreamCount = genres.filter(g => 
      Array.from(mainstreamGenres).some(mg => g.toLowerCase().includes(mg) || mg.includes(g.toLowerCase()))
    ).length;
    const ratio = mainstreamCount / genres.length;
    genreScore = Math.round((1 - ratio) * 10);
  }
  
  // Combined score (weighted: 60% year, 40% genre)
  const totalScore = (yearScore * 0.6) + (genreScore * 0.4);
  
  // Map to difficulty
  // 0-2.5 = einfach (very recent + mainstream)
  // 2.5-5.0 = mittel (moderately old or mixed genres)
  // 5.0+ = schwer (old or niche)
  if (totalScore <= 2.5) return 'einfach';
  if (totalScore <= 5.0) return 'mittel';
  return 'schwer';
}

// Update difficulty for each card
let einfach = 0, mittel = 0, schwer = 0;
for (const card of cards) {
  card.difficulty = calculateDifficulty(card);
  if (card.difficulty === 'einfach') einfach++;
  else if (card.difficulty === 'mittel') mittel++;
  else schwer++;
}

console.log(`Distribution: Einfach=${einfach}, Mittel=${mittel}, Schwer=${schwer}`);

// Reconstruct the file
const playlistInfoMatch = content.match(/(export const playlistInfo: PlaylistInfo\[\] = \[[\s\S]*?\];)/);
const header = `// AUTO-GENERATED by scripts/sync-playlist.mjs
// Do not edit manually.
import { Card } from './types';

export type PlaylistInfo = { id: string; name: string };
${playlistInfoMatch ? playlistInfoMatch[1] : ''}

export const playlistCards: Card[] = ${JSON.stringify(cards, null, 2)};
`;

fs.writeFileSync(inFile, header);
console.log(`Updated ${cards.length} songs in ${path.relative(root, inFile)}`);
